# -*- coding: utf-8 -*-
"""Stock Report.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Bx0LBKderaMGfz_gMfi_uTf8EYtM1QqG
"""

# ==========================================
# STEP 1: SETUP & MOUNT DRIVE
# ==========================================
import pandas as pd
import numpy as np
import glob
import os
import matplotlib.pyplot as plt
from sklearn.preprocessing import MinMaxScaler
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import LSTM, Dense, Dropout
from google.colab import drive

# Mount Google Drive
drive.mount('/content/drive')

# ==========================================
# STEP 2: LOAD & PROCESS DATA
# ==========================================
# USER INPUT: Change this path to your actual folder path in Drive
folder_path = '/content/drive/My Drive/dataset/stocks'

# Find all CSV files in the folder
all_files = glob.glob(folder_path + "/*.csv")

if not all_files:
    print(f"No CSV files found in {folder_path}. Please check the path.")
else:
    print(f"Found {len(all_files)} files. Loading...")

    # Read and concatenate all CSV files into one DataFrame
    df_list = [pd.read_csv(filename) for filename in all_files]
    dataset = pd.concat(df_list, axis=0, ignore_index=True)

    # DATA CLEANING
    # Ensure there is a 'Date' column and sort by it (Crucial for time series!)
    # Adjust 'Date' and 'Close' if your CSV headers are named differently
    dataset['Date'] = pd.to_datetime(dataset['Date'])
    dataset = dataset.sort_values('Date')

    # We will predict based on the 'Close' price
    data_target = dataset.filter(['Close']).values

    # Normalize data (Scale between 0 and 1 for the Neural Network)
    scaler = MinMaxScaler(feature_range=(0, 1))
    scaled_data = scaler.fit_transform(data_target)

    # ==========================================
    # STEP 3: PREPARE TRAINING DATA
    # ==========================================
    # We use the past 60 days to predict the next day
    prediction_days = 60

    x_train = []
    y_train = []

    # Create sequences: data[i-60] to data[i] is X, data[i] is Y
    for x in range(prediction_days, len(scaled_data)):
        x_train.append(scaled_data[x-prediction_days:x, 0])
        y_train.append(scaled_data[x, 0])

    x_train, y_train = np.array(x_train), np.array(y_train)
    # Reshape for LSTM [samples, time steps, features]
    x_train = np.reshape(x_train, (x_train.shape[0], x_train.shape[1], 1))

    # ==========================================
    # STEP 4: BUILD & TRAIN LSTM MODEL
    # ==========================================
    print("Training Model... (This may take a few minutes)")

    model = Sequential()
    # Layer 1
    model.add(LSTM(units=50, return_sequences=True, input_shape=(x_train.shape[1], 1)))
    model.add(Dropout(0.2))
    # Layer 2
    model.add(LSTM(units=50, return_sequences=False))
    model.add(Dropout(0.2))
    # Output Layer
    model.add(Dense(units=1)) # Prediction of the next closing price

    model.compile(optimizer='adam', loss='mean_squared_error')
    model.fit(x_train, y_train, epochs=25, batch_size=32)

    # ==========================================
    # STEP 5: PREDICT FUTURE PRICE
    # ==========================================
    # Get the last 60 days of data to predict the NEXT unknown day
    real_data = [scaled_data[len(scaled_data) + 1 - prediction_days : len(scaled_data+1), 0]]
    real_data = np.array(real_data)
    real_data = np.reshape(real_data, (real_data.shape[0], real_data.shape[1], 1))

    prediction = model.predict(real_data)
    real_prediction = scaler.inverse_transform(prediction)

    print("\n" + "="*40)
    print(f"PREDICTION: The predicted stock price for the next trading day is: ${real_prediction[0][0]:.2f}")
    print("="*40)

    # ==========================================
    # STEP 6: VISUALIZATION (Optional)
    # ==========================================
    # Plotting the historical data to see the trend
    plt.figure(figsize=(16,8))
    plt.title('Stock Price History')
    plt.plot(dataset['Date'], dataset['Close'])
    plt.xlabel('Date', fontsize=18)
    plt.ylabel('Close Price USD ($)', fontsize=18)
    plt.show()